---
title: "Datos"
author:
- Lourdes Sofía Elizondo Guajardo
- Daniela Diaz Delgado
- Bernardo Ortega Chávez
- Gabriel González Bataller
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
    number_sections: yes
  html_document:
    toc: yes
    toc_depth: '4'
    df_print: paged
subtitle: "Test"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("gmodels")
library("ggplot2")
library("pROC")
library("rpart")
library("rattle")
library("rpart.plot")
library("tinytex")
library("kableExtra")
library("ROSE")
library("tibble")
library("bitops")
library("tidyquant")
library("knitr")
library("plotly")
library("Sim.DiffProc")
library("readxl")
library("usethis")
library("curl")
library("dplyr")
library("tidyr")
library("scales")
library("RColorBrewer")
library("forcats")
library("ggrepel")
library("gridExtra")
```

# Data Analysis 

## Data Reported in Sistema de Información Infonavit: 2013/01-2021/04

First we analyze information regarding all mortgages originated by Infonavit **from January 2013 to April 2021**. Source: https://portalmx.infonavit.org.mx/wps/portal/infonavit.web/el-instituto/el-infonavit/SII/!ut/p/z1/pZBBDoIwFETP4gn-FJHWJRosFQKiqUA3pitCoujCeH7RJcSKcXY_eTN_MmSoItPZR9vYe3vt7Lm_axOcAgnEa59lQh05iijwc873yAWncgCkyQIFdonEFuzAQOYfv_am-T0ByBVYJkUsEG4iFS3TuSc1m-bHB4U_9x8Bxh1fkhm8GC_oBF4TvQHXBt9a3C66V4VWNbMnVfmrRQ!!/dz/d5/L2dBISEvZ0FBIS9nQSEh/

Variables:
NC: Número de créditos
MC: Monto de créditos
NS: Número de subsidios
MS: Monto de subsidios

```{r LoadingData1, include=FALSE}
# Número de Créditos Formalizados
NCTotal<-as.data.frame(read_excel("DATA/NumeroDeCreditosFormalizados.xlsx", sheet = 1))
MCTipoProducto<-as.data.frame(read_excel("DATA/NumeroDeCreditosFormalizados.xlsx", sheet = 2))
NCLinea<-as.data.frame(read_excel("DATA/NumeroDeCreditosFormalizados.xlsx", sheet = 3))
NCClasificacionVivienda<-as.data.frame(read_excel("DATA/NumeroDeCreditosFormalizados.xlsx", sheet = 4))
NCIngreso<-as.data.frame(read_excel("DATA/NumeroDeCreditosFormalizados.xlsx", sheet = 5))
NCEdad<-as.data.frame(read_excel("DATA/NumeroDeCreditosFormalizados.xlsx", sheet = 6))
NCEstado<-as.data.frame(read_excel("DATA/NumeroDeCreditosFormalizados.xlsx", sheet = 7))
## Totales
NC_TP<-as.data.frame(read_excel("DATA/Totales/NC.xlsx",sheet=1))
NC_L<-as.data.frame(read_excel("DATA/Totales/NC.xlsx",sheet=2))
NC_CV<-as.data.frame(read_excel("DATA/Totales/NC.xlsx",sheet=3))
NC_I<-as.data.frame(read_excel("DATA/Totales/NC.xlsx",sheet=4))
NC_Edad<-as.data.frame(read_excel("DATA/Totales/NC.xlsx",sheet=5))
NC_Estado<-as.data.frame(read_excel("DATA/Totales/NC.xlsx",sheet=6))


# Importe de Cheque
ITotal<-as.data.frame(read_excel("DATA/ImporteDeCheque.xlsx", sheet = 1))
ITipoProducto<-as.data.frame(read_excel("DATA/ImporteDeCheque.xlsx", sheet = 2))
ILinea<-as.data.frame(read_excel("DATA/ImporteDeCheque.xlsx", sheet = 3))
IClasificacionVivienda<-as.data.frame(read_excel("DATA/ImporteDeCheque.xlsx", sheet = 4))
IIngreso<-as.data.frame(read_excel("DATA/ImporteDeCheque.xlsx", sheet = 5))
IEdad<-as.data.frame(read_excel("DATA/ImporteDeCheque.xlsx", sheet = 6))
IEstado<-as.data.frame(read_excel("DATA/ImporteDeCheque.xlsx", sheet = 7))
## Totales
I_TP<-as.data.frame(read_excel("DATA/Totales/I.xlsx",sheet=1))
I_L<-as.data.frame(read_excel("DATA/Totales/I.xlsx",sheet=2))
I_CV<-as.data.frame(read_excel("DATA/Totales/I.xlsx",sheet=3))
I_I<-as.data.frame(read_excel("DATA/Totales/I.xlsx",sheet=4))
I_Edad<-as.data.frame(read_excel("DATA/Totales/I.xlsx",sheet=5))
I_Estado<-as.data.frame(read_excel("DATA/Totales/I.xlsx",sheet=6))


# Monto de Crédito Infonavit
MCTotal<-as.data.frame(read_excel("DATA/MontoDeCreditoInfonavit.xlsx", sheet = 1))
MCTipoProducto<-as.data.frame(read_excel("DATA/MontoDeCreditoInfonavit.xlsx", sheet = 2))
MCLinea<-as.data.frame(read_excel("DATA/MontoDeCreditoInfonavit.xlsx", sheet = 3))
MCClasificacionVivienda<-as.data.frame(read_excel("DATA/MontoDeCreditoInfonavit.xlsx", sheet = 4))
MCIngreso<-as.data.frame(read_excel("DATA/MontoDeCreditoInfonavit.xlsx", sheet = 5))
MCEdad<-as.data.frame(read_excel("DATA/MontoDeCreditoInfonavit.xlsx", sheet = 6))
MCEstado<-as.data.frame(read_excel("DATA/MontoDeCreditoInfonavit.xlsx", sheet = 7))
## Totales
MC_TP<-as.data.frame(read_excel("DATA/Totales/MC.xlsx",sheet=1))
MC_L<-as.data.frame(read_excel("DATA/Totales/MC.xlsx",sheet=2))
MC_CV<-as.data.frame(read_excel("DATA/Totales/MC.xlsx",sheet=3))
MC_I<-as.data.frame(read_excel("DATA/Totales/MC.xlsx",sheet=4))
MC_Edad<-as.data.frame(read_excel("DATA/Totales/MC.xlsx",sheet=5))
MC_Estado<-as.data.frame(read_excel("DATA/Totales/MC.xlsx",sheet=6))


# Número de Subsidios
NSTotal<-as.data.frame(read_excel("DATA/NumeroDeSubsidios.xlsx", sheet = 1))
NSTipoProducto<-as.data.frame(read_excel("DATA/NumeroDeSubsidios.xlsx", sheet = 2))
NSLinea<-as.data.frame(read_excel("DATA/NumeroDeSubsidios.xlsx", sheet = 3))
NSClasificacionVivienda<-as.data.frame(read_excel("DATA/NumeroDeSubsidios.xlsx", sheet = 4))
NSIngreso<-as.data.frame(read_excel("DATA/NumeroDeSubsidios.xlsx", sheet = 5))
NSEdad<-as.data.frame(read_excel("DATA/NumeroDeSubsidios.xlsx", sheet = 6))
NSEstado<-as.data.frame(read_excel("DATA/NumeroDeSubsidios.xlsx", sheet = 7))
## Totales
NS_TP<-as.data.frame(read_excel("DATA/Totales/NS.xlsx",sheet=1))
NS_L<-as.data.frame(read_excel("DATA/Totales/NS.xlsx",sheet=2))
NS_CV<-as.data.frame(read_excel("DATA/Totales/NS.xlsx",sheet=3))
NS_I<-as.data.frame(read_excel("DATA/Totales/NS.xlsx",sheet=4))
NS_Edad<-as.data.frame(read_excel("DATA/Totales/NS.xlsx",sheet=5))
NS_Estado<-as.data.frame(read_excel("DATA/Totales/NS.xlsx",sheet=6))


# Monto de Subsidios
MSTotal<-as.data.frame(read_excel("DATA/MontoDeSubsidios.xlsx", sheet = 1))
MSTipoProducto<-as.data.frame(read_excel("DATA/MontoDeSubsidios.xlsx", sheet = 2))
MSLinea<-as.data.frame(read_excel("DATA/MontoDeSubsidios.xlsx", sheet = 3))
MSClasificacionVivienda<-as.data.frame(read_excel("DATA/MontoDeSubsidios.xlsx", sheet = 4))
MSIngreso<-as.data.frame(read_excel("DATA/MontoDeSubsidios.xlsx", sheet = 5))
MSEdad<-as.data.frame(read_excel("DATA/MontoDeSubsidios.xlsx", sheet = 6))
MSEstado<-as.data.frame(read_excel("DATA/MontoDeSubsidios.xlsx", sheet = 7))
## Totales
MS_TP<-as.data.frame(read_excel("DATA/Totales/MS.xlsx",sheet=1))
MS_L<-as.data.frame(read_excel("DATA/Totales/MS.xlsx",sheet=2))
MS_CV<-as.data.frame(read_excel("DATA/Totales/MS.xlsx",sheet=3))
MS_I<-as.data.frame(read_excel("DATA/Totales/MS.xlsx",sheet=4))
MS_Edad<-as.data.frame(read_excel("DATA/Totales/MS.xlsx",sheet=5))
MS_Estado<-as.data.frame(read_excel("DATA/Totales/MS.xlsx",sheet=6))

# Recaudación y Fiscalización de las Aportaciones Patronales
RFAP<-as.data.frame(read_excel("DATA/RecaudacionYFiscalizacionDeAportacionesPatronales.xlsx", sheet = 1))

# Administración de la Subcuenta de Vivienda
ASV<-as.data.frame(read_excel("DATA/AdminSubcuentaDeVivienda.xlsx", sheet = 1))
```

### Number of Credits Granted 

Website variable description: Número de créditos del Infonavit aprobados y signados. Incluye los productos hipotecarios para vivienda nueva o existente, créditos cofinanciados, créditos coparticipados,mejoramientos y autoproducción. Cifras preliminares.

```{r TotalsNC_CODE, include=FALSE}
# Por Estado
barplot_NC_Estado<-ggplot(data=NC_Estado)+
  geom_bar(aes(x=reorder(Estado,-NC),y=NC,fill=Estado),stat = "identity")+
  geom_text(aes(x=Estado,y=NC,label=NC),hjust=-0.2, size=2.5,angle=90)+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(32))+
  labs( x = "State", 
        y = "Number of loans granted",
        title ="Loan distribution per State",
        subtitle = "2013/01 - 2021/04"
        )+
  ylim(0,625000)+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=0,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )

# Por Estado como porcentaje
percent_Estado<-paste(round(100*(NC_Estado$NC/(sum(NC_Estado$NC))), 2), "%", sep="")
NC_Estado$percent<-percent_Estado

barplot_NC_Estado_percent<-ggplot(data=NC_Estado)+
  geom_bar(aes(x=reorder(Estado,-NC),y=NC,fill=Estado),stat = "identity")+
  geom_text(aes(x=Estado,y=NC,label=percent_Estado),hjust=-0.2, size=2.5,angle=90)+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(32))+
  labs( x = "State", 
        y = "% / Total Loans Granted",
        title ="Loan distribution per State",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=0,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )+ylim(0,625000)
  

# Por Tipo de Producto
percent_TP<-paste(round(100*(NC_TP$NC/(sum(NC_TP$NC))), 2), "%", sep="")
NC_TP$percent=percent_TP

piechart_NC_TP<-ggplot(data=NC_TP, aes(x="", y=NC, fill=TipoProducto)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+
  geom_label_repel(aes(label = percent_TP), size=3.5, show.legend = F, position = position_stack(vjust = 0.5)) +
  guides(fill = guide_legend(title = "Product Type"))+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(8))+
  labs(
    y="",
    x="",
    title="Loan Distribution by Product Type",
    subtitle="2013/01 - 2021/04"
  )+
  theme(
    plot.title = element_text(hjust=0.5),
    plot.subtitle = element_text(hjust=0.5),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid  = element_blank()
  )

# Por Clasificación de Vivienda
percent_CV<-paste(round(100*(NC_CV$NC/(sum(NC_CV$NC))), 2), "%", sep="")
NC_CV$percent=percent_CV

piechart_NC_CV<-ggplot(data=NC_CV, aes(x="", y=NC, fill=ClasificacionVivienda)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+
  geom_label_repel(aes(label = percent_CV), size=3.5, show.legend = F, position = position_stack(vjust = 0.5)) +
  guides(fill = guide_legend(title = "Dwelling Classification"))+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(8))+
  labs(
    y="",
    x="",
    title="Loan Distribution by Dwelling Classification",
    subtitle="2013/01 - 2021/04"
  )+
  theme(
    plot.title = element_text(hjust=0.5),
    plot.subtitle = element_text(hjust=0.5),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid  = element_blank()
  )

# Por Linea
percent_L<-paste(round(100*(NC_L$NC/(sum(NC_L$NC))), 2), "%", sep="")
NC_L$percent=percent_L

piechart_NC_L<-ggplot(data=NC_L, aes(x="", y=NC, fill=Linea)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+
  geom_label_repel(aes(label = percent_L), size=3.5, show.legend = F, position = position_stack(vjust = 0.5)) +
  guides(fill = guide_legend(title = "Credit Line"))+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(8))+
  labs(
    y="",
    x="",
    title="Loan Distribution by Credit Line",
    subtitle="2013/01 - 2021/04"
  )+
  theme(
    plot.title = element_text(hjust=0.5),
    plot.subtitle = element_text(hjust=0.5),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid  = element_blank()
  )

# Por Ingreso
UMA<-c("1","1-2","2-3","3-4","4-5","5-6","6-7","7-8","8-9","9-10","10-11","11-12","12-13","13-14","14-15","15-16","16-17","17-18","18-19","19-20","20-21","21-22","22-23","23-24","24-25","25+","Other")
NC_I$UMA<-UMA

barplot_NC_I<-ggplot(data=NC_I)+
  geom_bar(aes(x=reorder(UMA,-NC),y=NC,fill=UMA),stat = "identity")+
  geom_text(aes(x=UMA,y=NC,label=NC),hjust=-0.2, size=2.5,angle=90)+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(nrow(NC_I)))+
  labs( x = "Income (UMA)", 
        y = "Number of loans granted",
        title ="Loans distribution by Income (UMA)",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=0,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )+
  coord_cartesian(ylim=c(0,1300000))

# Por Edad
Edad2<-c("20","21-25","26-30","31-35","36-40","41-45","46-50","51-55","56-60","61-65","65+","Otros")
NC_Edad$Edad2<-Edad2

barplot_NC_Edad<-ggplot(data=NC_Edad)+
  geom_bar(aes(x=Edad2,y=NC,fill=Edad2),stat = "identity")+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(nrow(NC_I)))+
  labs( x = "Age group", 
        y = "Number of loans granted",
        title ="Loan distribution by Age",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=6,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )
```
```{r TotalsNC_GRAPHS, fig.align='center'}
barplot_NC_Estado
barplot_NC_Estado_percent
piechart_NC_TP
piechart_NC_CV
piechart_NC_L
barplot_NC_I
barplot_NC_Edad
```

### Credit Amount (MXN)

Website variable description: Recursos del fondo para financiar una acción de vivienda y que constituye el pasivo que el trabajador adquiere con el Instituto. En productos cofinanciados y coparticipados, se considera únicamente la parte financiada por el Infonavit. No se consideran productos donde el Instituto únicamente provee la garantía hipotecaria. A precios corrientes. Cifras preliminares.

```{r TotalsMC_CODE, include=FALSE}
# Por Estado
barplot_MC_Estado<-ggplot(data=MC_Estado)+
  geom_bar(aes(x=reorder(Estado,-MC),y=MC,fill=Estado),stat = "identity")+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(32))+
  labs( x = "State", 
        y = "Credit amount (MXN)",
        title ="Total Amount of Granted Credit by State",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=8,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )

# Por Estado (Monto / Número de cuentas)
MC_NC<-(MC_Estado$MC)/(NC_Estado$NC)
MC_Estado$MC_NC<-MC_NC

barplot_MC_Estado_av<-ggplot(data=MC_Estado)+
  geom_bar(aes(x=reorder(Estado,-MC_NC),y=MC_NC,fill=Estado),stat = "identity")+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(32))+
  labs( x = "State", 
        y = "(Total credit amount / Number of accounts)",
        title ="Average credit amount per State",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=8,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )

# Por Estado como porcentaje
percent_Estado2<-paste(round(100*(MC_Estado$MC/(sum(MC_Estado$MC))), 2), "%", sep="")
MC_Estado$percent<-percent_Estado2

barplot_MC_Estado_percent<-ggplot(data=MC_Estado)+
  geom_bar(aes(x=reorder(Estado,-MC),y=MC,fill=Estado),stat = "identity")+
  geom_text(aes(x=Estado,y=MC,label=percent_Estado2),hjust=-0.2, size=2.5,angle=90)+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(32))+
  labs( x = "State", 
        y = "% / Total Amount of Credit",
        title ="Total Amount of Granted Credit by State (%)",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=0,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )+ylim(0,143000000000)

# Por Tipo de Producto
percent_TP2<-paste(round(100*(MC_TP$MC/(sum(MC_TP$MC))), 2), "%", sep="")
MC_TP$percent=percent_TP2

piechart_MC_TP<-ggplot(data=MC_TP, aes(x="", y=MC, fill=TipoProducto)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+
  geom_label_repel(aes(label = percent_TP2), size=3, show.legend = F, position = position_stack(vjust = 0.5),max.overlaps = Inf) +
  guides(fill = guide_legend(title = "Product Type"))+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(8))+
  labs(
    y="",
    x="",
    title="Total Amount of Granted Credit by Product Type",
    subtitle="2013/01 - 2021/04"
  )+
  theme(
    plot.title = element_text(hjust=0.5),
    plot.subtitle = element_text(hjust=0.5),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid  = element_blank()
  )

# Por Clasificación de Vivienda
percent_CV2<-paste(round(100*(MC_CV$MC/(sum(MC_CV$MC))), 2), "%", sep="")
MC_CV$percent=percent_CV2

piechart_MC_CV<-ggplot(data=MC_CV, aes(x="", y=MC, fill=ClasificacionVivienda)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+
  geom_label_repel(aes(label = percent_CV2), size=3.5, show.legend = F, position = position_stack(vjust = 0.5)) +
  guides(fill = guide_legend(title = "Dwelling Classification"))+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(8))+
  labs(
    y="",
    x="",
    title="Total Amount of Granted Credit by Dwelling Classification",
    subtitle="2013/01 - 2021/04"
  )+
  theme(
    plot.title = element_text(hjust=0.5),
    plot.subtitle = element_text(hjust=0.5),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid  = element_blank()
  )

# Por Linea
percent_L2<-paste(round(100*(MC_L$MC/(sum(MC_L$MC))), 2), "%", sep="")
MC_L$percent=percent_L2

piechart_MC_L<-ggplot(data=MC_L, aes(x="", y=MC, fill=Linea)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+
  geom_label_repel(aes(label = percent_L2), size=3.5, show.legend = F, position = position_stack(vjust = 0.5)) +
  guides(fill = guide_legend(title = "Credit Line"))+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(8))+
  labs(
    y="",
    x="",
    title="Total Amount of Granted Credit by Credit Line",
    subtitle="2013/01 - 2021/04"
  )+
  theme(
    plot.title = element_text(hjust=0.5),
    plot.subtitle = element_text(hjust=0.5),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid  = element_blank()
  )

# Por Ingreso
MC_I$UMA<-UMA

barplot_MC_I<-ggplot(data=MC_I)+
  geom_bar(aes(x=reorder(UMA,-MC),y=MC,fill=UMA),stat = "identity")+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(nrow(MC_I)))+
  labs( x = "Income (UMA)", 
        y = "Credit Amount (MXN)",
        title ="Total Amount of Granted Credit by Income (UMA)",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=8,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )

# Por Edad
MC_Edad$Edad2<-Edad2

barplot_MC_Edad<-ggplot(data=MC_Edad)+
  geom_bar(aes(x=Edad2,y=MC,fill=Edad2),stat = "identity")+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(nrow(MC_I)))+
  labs( x = "Age group", 
        y = "Credit Amount (MXN)",
        title ="Total Amount of Granted Credit by Age",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=6,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )
```
```{r TotalsMC_GRAPHS, fig.align='center'}
barplot_MC_Estado
barplot_MC_Estado_av
barplot_MC_Estado_percent
piechart_MC_TP
piechart_MC_CV
piechart_MC_L
barplot_MC_I
barplot_MC_Edad
```

### Subsidies

#### Number

Website variable description: Número de créditos que recibieron el subsidio federal otorgado por la Comisión Nacional de Vivienda (Conavi). Se consideran únicamente los subsidios dispersados a través de un crédito de vivienda del Infonavit. Cifras preliminares.

```{r TotalsNS_CODE, include=FALSE}

# Por Estado
barplot_NS_Estado<-ggplot(data=NS_Estado)+
  geom_bar(aes(x=reorder(Estado,-NS),y=NS,fill=Estado),stat = "identity")+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(32))+
  labs( x = "State", 
        y = "Number of Subsidies",
        title ="Number of Granted Subsidies by State",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=8,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )

# Por Estado como porcentaje del total de CREDITOS subsidiados y no subsidiados
proportion<-(NS_Estado$NS)/(NC_Estado$NC)
NS_Estado$prop<-proportion

barplot_NS_Estado_prop<-ggplot(data=NS_Estado)+
  geom_bar(aes(x=reorder(Estado,-prop),y=prop,fill=Estado),stat = "identity")+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(32))+
  labs( x = "State", 
        y = "(Subsidized Loans / Total Loans)",
        title ="% of subsidized loans per State ",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=8,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )

# Por Estado como porcentaje del total de subsidios
percent_Estado3<-paste(round(100*(NS_Estado$NS/(sum(NS_Estado$NS))), 2), "%", sep="")
NS_Estado$percent<-percent_Estado3

barplot_NS_Estado_percent<-ggplot(data=NS_Estado)+
  geom_bar(aes(x=reorder(Estado,-NS),y=NS,fill=Estado),stat = "identity")+
  geom_text(aes(x=Estado,y=NS,label=percent_Estado3),hjust=-0.2, size=2.5,angle=90)+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(32))+
  labs( x = "State", 
        y = "% / Total Subsidies Granted",
        title ="Number of Granted Subsidies by State (%)",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=0,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )+
  ylim(0,110000)

# Por Tipo de Producto
# No Aplica: Todos son crédito tradicional

# Por Clasificación de Vivienda
percent_CV3<-paste(round(100*(NS_CV$NS/(sum(NS_CV$NS))), 2), "%", sep="")
NS_CV$percent=percent_CV3

piechart_NS_CV<-ggplot(data=NS_CV, aes(x="", y=NS, fill=ClasificacionVivienda)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+
  geom_label_repel(aes(label = percent_CV3), size=3.5, show.legend = F, position = position_stack(vjust = 0.5),max.overlaps = Inf) +
  guides(fill = guide_legend(title = "Dwelling Classification"))+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(8))+
  labs(
    y="",
    x="",
    title="Distribution of Subsidies by Dwelling Classification",
    subtitle="2013/01 - 2021/04"
  )+
  theme(
    plot.title = element_text(hjust=0.5),
    plot.subtitle = element_text(hjust=0.5),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid  = element_blank()
  )

# Por Linea
percent_L3<-paste(round(100*(NS_L$NS/(sum(NS_L$NS))), 2), "%", sep="")
NS_L$percent=percent_L3

piechart_NS_L<-ggplot(data=NS_L, aes(x="", y=NS, fill=Linea)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+
  geom_label_repel(aes(label = percent_L3), size=3.5, show.legend = F, position = position_stack(vjust = 0.5),max.overlaps = Inf) +
  guides(fill = guide_legend(title = "Credit Line"))+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(8))+
  labs(
    y="",
    x="",
    title="Distribution of Subsidies by Credit Line",
    subtitle="2013/01 - 2021/04"
  )+
  theme(
    plot.title = element_text(hjust=0.5),
    plot.subtitle = element_text(hjust=0.5),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid  = element_blank()
  )

# Por Ingreso
NS_I$UMA<-UMA

barplot_NS_I<-ggplot(data=NS_I)+
  geom_bar(aes(x=reorder(UMA,-NS),y=NS,fill=UMA),stat = "identity")+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(nrow(NS_I)))+
  labs( x = "Income (UMA)", 
        y = "Number of Subsidies",
        title ="Number of Granted Subsidies by Income (UMA)",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=8,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )

# Por Edad
NS_Edad$Edad2<-Edad2

barplot_NS_Edad<-ggplot(data=NS_Edad)+
  geom_bar(aes(x=Edad2,y=NS,fill=Edad2),stat = "identity")+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(nrow(NS_I)))+
  labs( x = "Age group", 
        y = "Number of Subsidies",
        title ="Number of Granted Subsidies by Age",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=6,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )
```
```{r TotalsNS_GRAPHS, fig.align='center'}
barplot_NS_Estado
barplot_NS_Estado_prop
barplot_NS_Estado_percent
piechart_NS_CV
piechart_NS_L
barplot_NS_I
barplot_NS_Edad
```

#### Amount ($MXN)

Website variable description: Monto de subsidio del gobierno federal otorgado por la Comisión Nacional de Vivienda (Conavi), como complemento a un crédito Infonavit. Se consideran únicamente los subsidios dispersados a través de un crédito de vivienda del Infonavit. A precios corrientes. Cifras preliminares.

```{r TotalsMS_CODE, include=FALSE}
# Por Estado
barplot_MS_Estado<-ggplot(data=MS_Estado)+
  geom_bar(aes(x=reorder(Estado,-MS),y=MS,fill=Estado),stat = "identity")+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(32))+
  labs( x = "State", 
        y = "Amount (MXN)",
        title ="Amount of Granted Subsidies by State",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=8,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )

# Por Estado como porcentaje
percent_Estado4<-paste(round(100*(MS_Estado$MS/(sum(MS_Estado$MS))), 2), "%", sep="")
MS_Estado$percent<-percent_Estado4

barplot_MS_Estado_percent<-ggplot(data=MS_Estado)+
  geom_bar(aes(x=reorder(Estado,-MS),y=MS,fill=Estado),stat = "identity")+
  geom_text(aes(x=Estado,y=MS,label=percent_Estado4),hjust=-0.2, size=2.5,angle=90)+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(32))+
  labs( x = "State", 
        y = "% / Total Amount",
        title ="Amount of Granted Subsidies by State (%)",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=0,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )

# Por Tipo de Producto
# No Aplica: Todos son crédito tradicional

# Por Clasificación de Vivienda
percent_CV4<-paste(round(100*(MS_CV$MS/(sum(MS_CV$MS))), 2), "%", sep="")
MS_CV$percent=percent_CV4

piechart_MS_CV<-ggplot(data=MS_CV, aes(x="", y=MS, fill=ClasificacionVivienda)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+
  geom_label_repel(aes(label = percent_CV4), size=3.5, show.legend = F, position = position_stack(vjust = 0.5),max.overlaps = Inf) +
  guides(fill = guide_legend(title = "Dwelling Classification"))+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(8))+
  labs(
    y="",
    x="",
    title="Amount of Subsidies by Dwelling Classification",
    subtitle="2013/01 - 2021/04"
  )+
  theme(
    plot.title = element_text(hjust=0.5),
    plot.subtitle = element_text(hjust=0.5),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid  = element_blank()
  )

# Por Linea
percent_L4<-paste(round(100*(MS_L$MS/(sum(MS_L$MS))), 2), "%", sep="")
MS_L$percent=percent_L4

piechart_MS_L<-ggplot(data=MS_L, aes(x="", y=MS, fill=Linea)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0)+
  geom_label_repel(aes(label = percent_L4), size=3.5, show.legend = F, position = position_stack(vjust = 0.5),max.overlaps = Inf) +
  guides(fill = guide_legend(title = "Credit Line"))+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(8))+
  labs(
    y="",
    x="",
    title="Amount of Subsidies by Credit Line",
    subtitle="2013/01 - 2021/04"
  )+
  theme(
    plot.title = element_text(hjust=0.5),
    plot.subtitle = element_text(hjust=0.5),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid  = element_blank()
  )

# Por Ingreso
MS_I$UMA<-UMA

barplot_MS_I<-ggplot(data=MS_I)+
  geom_bar(aes(x=reorder(UMA,-MS),y=MS,fill=UMA),stat = "identity")+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(nrow(MS_I)))+
  labs( x = "Income (UMA)", 
        y = "Amount (MXN)",
        title ="Amount of Granted Subsidies by Income",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=8,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )

# Por Edad
MS_Edad$Edad2<-Edad2

barplot_MS_Edad<-ggplot(data=MS_Edad)+
  geom_bar(aes(x=Edad2,y=MS,fill=Edad2),stat = "identity")+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(nrow(MS_I)))+
  labs( x = "Age group", 
        y = "Amount (MXN)",
        title ="Amount of Granted Subsidies by Age",
        subtitle = "2013/01 - 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=6,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )
```
```{r TotalsMS_GRAPHS, fig.align='center'}
barplot_MS_Estado
barplot_MS_Estado_percent
piechart_MS_CV
piechart_MS_L
barplot_MS_I
barplot_MS_Edad
```

Solo para ver **seasonality** en el número de créditos otorgados por mes:
```{r TimeSeries, fig.align='center'}
timeseries_NCTotal<-ggplot(data=NCTotal)+
  geom_line(aes(x=Fecha,y=TotalNacional))
timeseries_NCTotal
```

## Data Reported in Sistema de Información Infonavit: Complete Portfolio Analysis

Source: https://portalmx.infonavit.org.mx/wps/portal/infonavit.web/transparencia/estaditicas/!ut/p/z1/jY_BCsIwEEQ_aTdNSdZjUmtalKQFQ-tepCcJaPUgfr8iXjwYO7eBNzMMMIzA8_RIp-mervN0fvkDq6NyiE1VCh_MtsSebIdWd1IZDcMbKAjRWRTeUUNoNnVbr3aycFEAL8njDxlcls8AnK8fgL8nnCXC3u29rUKQtNYfIHfx38jtEuOIqX0C2OrEmg!!/dz/d5/L2dBISEvZ0FBIS9nQSEh/

Leaving behind the database of NC, MC, NS, MS -> we now consider the information reported in the section "Estadísticas" of Sistema de Información Infonavit, which gives operating indicators of Infonavit's **complete** portfolio. 

This database decomposes Infonavit's portfolio by: past due portfolio (vencida), extension portfolio (prórrroga) and current portfolio (vigente). 

Note that at the beginning of this document we were analyzing credits originated from January 2013 to April 2021, but now this new database includes mortgages originated **before** 2013, considering the **complete portfolio** as of 30th of April, 2021.

Note: ICV stands for índice de cartera vencida (Vencida / Total)

```{r LoadingData2, include=FALSE}
# Complete Portfolio (CP) composition 2018-2021
# C Cuentas, S Saldos
C_21<-as.data.frame(read_excel("DATA/CarteraVencida.xlsx", sheet = 1))
C_20<-as.data.frame(read_excel("DATA/CarteraVencida.xlsx", sheet = 2))
C_19<-as.data.frame(read_excel("DATA/CarteraVencida.xlsx", sheet = 3))
C_18<-as.data.frame(read_excel("DATA/CarteraVencida.xlsx", sheet = 4))
C<-rbind(C_21,C_20,C_19,C_18)

S_21<-as.data.frame(read_excel("DATA/CarteraVencida.xlsx", sheet = 5))
S_20<-as.data.frame(read_excel("DATA/CarteraVencida.xlsx", sheet = 6))
S_19<-as.data.frame(read_excel("DATA/CarteraVencida.xlsx", sheet = 7))
S_18<-as.data.frame(read_excel("DATA/CarteraVencida.xlsx", sheet = 8))
S<-rbind(S_21,S_20,S_19,S_18)

anual_C<-as.data.frame(read_excel("DATA/CarteraVencida.xlsx", sheet = 9))
anual_S<-as.data.frame(read_excel("DATA/CarteraVencida.xlsx", sheet = 10))

# AJUSTE: data tidy para gráfica
C_21_2<-subset(C_21,select=-c(Fecha,Total,ICV))
C_20_2<-subset(C_20,select=-c(Fecha,Total,ICV))
C_19_2<-subset(C_19,select=-c(Fecha,Total,ICV))
C_18_2<-subset(C_18,select=-c(Fecha,Total,ICV))

S_21_2<-subset(S_21,select=-c(Fecha,Total,ICV))
S_20_2<-subset(S_20,select=-c(Fecha,Total,ICV))
S_19_2<-subset(S_19,select=-c(Fecha,Total,ICV))
S_18_2<-subset(S_18,select=-c(Fecha,Total,ICV))

C_21_3<-pivot_longer(C_21_2,cols = 2:4,names_to="Status",values_to = "Cuentas")
C_20_3<-pivot_longer(C_20_2,cols = 2:4,names_to="Status",values_to = "Cuentas")
C_19_3<-pivot_longer(C_19_2,cols = 2:4,names_to="Status",values_to = "Cuentas")
C_18_3<-pivot_longer(C_18_2,cols = 2:4,names_to="Status",values_to = "Cuentas")

S_21_3<-pivot_longer(S_21_2,cols = 2:4,names_to="Status",values_to = "Saldos")
S_20_3<-pivot_longer(S_20_2,cols = 2:4,names_to="Status",values_to = "Saldos")
S_19_3<-pivot_longer(S_19_2,cols = 2:4,names_to="Status",values_to = "Saldos")
S_18_3<-pivot_longer(S_18_2,cols = 2:4,names_to="Status",values_to = "Saldos")
```
```{r CompletePortfolio_CODE, include = FALSE}
## Por Estado y Año Cuentas *PENDIENTE**PENDIENTE*
# 2018
barC18<-ggplot(C_18_3, aes(fill = Status, y = Cuentas, x = Estado)) +
  geom_bar(position = "stack", stat = "identity")+
  labs( x = "State", 
        y = "Accounts (#)",
        title ="2018"
        )+
  theme(
    axis.text.x=element_text(size=5,angle=45,hjust=1),
    axis.text.y=element_text(size=7,angle=45),
    plot.title = element_text(size=11,hjust=0.5),
    axis.title.x = element_text(size=9),
    axis.title.y = element_text(size=9),
    legend.title = element_text(size=7),
    legend.text = element_text(size=7)
    )
# 2019
barC19<-ggplot(C_19_3, aes(fill = Status, y = Cuentas, x = Estado)) +
  geom_bar(position = "stack", stat = "identity")+
  labs( x = "State", 
        y = "Accounts (#)",
        title ="2019"
        )+
  theme(
    axis.text.x=element_text(size=5,angle=45,hjust=1),
    axis.text.y=element_text(size=7,angle=45),
    plot.title = element_text(size=11,hjust=0.5),
    axis.title.x = element_text(size=9),
    axis.title.y = element_text(size=9),
    legend.title = element_text(size=7),
    legend.text = element_text(size=7)
    )
# 2020
barC20<-ggplot(C_20_3, aes(fill = Status, y = Cuentas, x = Estado)) +
  geom_bar(position = "stack", stat = "identity")+
  labs( x = "State", 
        y = "Accounts (#)",
        title ="2020"
        )+
  theme(
    axis.text.x=element_text(size=5,angle=45,hjust=1),
    axis.text.y=element_text(size=7,angle=45),
    plot.title = element_text(size=11,hjust=0.5),
    axis.title.x = element_text(size=9),
    axis.title.y = element_text(size=9),
    legend.title = element_text(size=7),
    legend.text = element_text(size=7)
    )
# 2021
barC21<-ggplot(C_21_3, aes(fill = Status, y = Cuentas, x = Estado)) +
  geom_bar(position = "stack", stat = "identity")+
  labs( x = "State", 
        y = "Accounts (#)",
        title ="2021"
        )+
  theme(
    axis.text.x=element_text(size=5,angle=45,hjust=1),
    axis.text.y=element_text(size=7,angle=45),
    plot.title = element_text(size=11,hjust=0.5),
    axis.title.x = element_text(size=9),
    axis.title.y = element_text(size=9),
    legend.title = element_text(size=7),
    legend.text = element_text(size=7)
    )

## Por Estado y Año Saldos *PENDIENTE**PENDIENTE*
#2018
barS18<-ggplot(S_18_3, aes(fill = Status, y = Saldos, x = Estado)) +
  geom_bar(position = "stack", stat = "identity")+
  labs( x = "State", 
        y = "Balance (million MXN)",
        title ="2018"
        )+
  theme(
    axis.text.x=element_text(size=5,angle=45,hjust=1),
    axis.text.y=element_text(size=7,angle=45),
    plot.title = element_text(size=11,hjust=0.5),
    axis.title.x = element_text(size=9),
    axis.title.y = element_text(size=9),
    legend.title = element_text(size=7),
    legend.text = element_text(size=7)
    )
# 2019
barS19<-ggplot(S_19_3, aes(fill = Status, y = Saldos, x = Estado)) +
  geom_bar(position = "stack", stat = "identity")+
  labs( x = "State", 
        y = "Balance (million MXN)",
        title ="2019"
        )+
  theme(
    axis.text.x=element_text(size=5,angle=45,hjust=1),
    axis.text.y=element_text(size=7,angle=45),
    plot.title = element_text(size=11,hjust=0.5),
    axis.title.x = element_text(size=9),
    axis.title.y = element_text(size=9),
    legend.title = element_text(size=7),
    legend.text = element_text(size=7)
    )
# 2020
barS20<-ggplot(S_20_3, aes(fill = Status, y = Saldos, x = Estado)) +
  geom_bar(position = "stack", stat = "identity")+
  labs( x = "State", 
        y = "Balance (million MXN)",
        title ="2020"
        )+
  theme(
    axis.text.x=element_text(size=5,angle=45,hjust=1),
    axis.text.y=element_text(size=7,angle=45),
    plot.title = element_text(size=11,hjust=0.5),
    axis.title.x = element_text(size=9),
    axis.title.y = element_text(size=9),
    legend.title = element_text(size=7),
    legend.text = element_text(size=7)
    )
# 2021
barS21<-ggplot(S_21_3, aes(fill = Status, y = Saldos, x = Estado)) +
  geom_bar(position = "stack", stat = "identity")+
  labs( x = "State", 
        y = "Balance (million MXN)",
        title ="2021"
        )+
  theme(
    axis.text.x=element_text(size=5,angle=45,hjust=1),
    axis.text.y=element_text(size=7,angle=45),
    plot.title = element_text(size=11,hjust=0.5),
    axis.title.x = element_text(size=9),
    axis.title.y = element_text(size=9),
    legend.title = element_text(size=7),
    legend.text = element_text(size=7)
    )

## 2021 C Y S (más reciente)
barC21_solo<-ggplot(C_21_3, aes(fill = Status, y = Cuentas, x = Estado)) +
  geom_bar(position = "stack", stat = "identity")+
  labs( x = "State", 
        y = "Accounts (#)",
        title ="Complete Portfolio Composition",
        subtitle="Number of accounts - 2021"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=8,angle=45),
    plot.title = element_text(size=13,hjust=0.5),
    plot.subtitle = element_text(hjust=0.5),
    axis.title.x = element_text(size=11),
    axis.title.y = element_text(size=11),
    legend.title = element_text(size=10),
    legend.text = element_text(size=10)
    )

barS21_solo<-ggplot(S_21_3, aes(fill = Status, y = Saldos, x = Estado)) +
  geom_bar(position = "stack", stat = "identity")+
  labs( x = "State", 
        y = "Balance (million MXN)",
        title ="Complete Portfolio Composition",
        subtitle="Balance ($MXN) - 2021"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=8,angle=45),
    plot.title = element_text(size=13,hjust=0.5),
    plot.subtitle = element_text(hjust=0.5),
    axis.title.x = element_text(size=11),
    axis.title.y = element_text(size=11),
    legend.title = element_text(size=10),
    legend.text = element_text(size=10)
    )

## Cuentas - Final Anual (2018-2021)
anualc<-ggplot(data=anual_C,x=Fecha,y=ICV_Cuentas)+
  geom_line(aes(x=Fecha,y=ICV_Cuentas), color="gray47")+
  geom_point(aes(x=Fecha,y=ICV_Cuentas,shape="1", size = 5), color="darkslategray4")+
  labs(
    x="Year",
    y="Past Due Portfolio Index",
    title="Infonavit's Past Due Portfolio Index",
    subtitle="In Number of Accounts"
  )+
  theme(
    axis.text.x=element_text(size=10,angle=45,hjust=1),
    axis.text.y=element_text(size=10,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
  )

## Saldos - Final Anual (2003-2021)
anuals<-ggplot(data=anual_S,x=Fecha,y=ICV_Saldos)+
  geom_line(aes(x=Fecha,y=ICV_Saldos), color="gray47")+
  geom_point(aes(x=Fecha,y=ICV_Saldos,shape="1", size = 5), color="darkslategray4")+
  labs(
    x="Year",
    y="Past Due Portfolio Index",
    title="Infonavit's Past Due Portfolio Index",
    subtitle="In Credit Amount ($MXN)"
  )+
  theme(
    axis.text.x=element_text(size=10,angle=45,hjust=1),
    axis.text.y=element_text(size=10,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
  )
```
```{r TOTAL, include=FALSE}
# Número de cuentas por estado 2021/04, portafolio completo
NC_21<-subset(C_21,select=-c(Fecha,Vigente,Prorroga,Vencida,ICV))
NC_21$Percent=paste(round(100*(NC_21$Total/sum(NC_21$Total)), 2), "%", sep="")
barNC_complete<-ggplot(data=NC_21)+
  geom_bar(aes(x=reorder(Estado,-Total),y=Total,fill=Estado),stat = "identity")+
  geom_text(aes(x=Estado,y=Total,label=Percent),hjust=-0.2, size=2.5,angle=90)+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(32))+
  labs( x = "State", 
        y = "Number of Accounts",
        title ="Number of Accounts in Complete Portfolio",
        subtitle = "As of 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=8,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )+
  ylim(0,760000)
# Saldo de cuentas por estado 2021/04, portafolio completo
MC_21<-subset(S_21,select=-c(Fecha,Vigente,Prorroga,Vencida,ICV))
MC_21$Percent=paste(round(100*(MC_21$Total/sum(MC_21$Total)), 2), "%", sep="")
barMC_complete<-ggplot(data=MC_21)+
  geom_bar(aes(x=reorder(Estado,-Total),y=Total,fill=Estado),stat = "identity")+
  geom_text(aes(x=Estado,y=Total,label=Percent),hjust=-0.2, size=2.5,angle=90)+
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Set3"))(32))+
  labs( x = "State", 
        y = "Credit Balance (MXN)",
        title ="Total Balance in Complete Portfolio",
        subtitle = "As of 2021/04"
        )+
  theme(
    axis.text.x=element_text(size=8,angle=45,hjust=1),
    axis.text.y=element_text(size=8,angle=45),
    plot.title = element_text(hjust=0.5),
    plot.subtitle=element_text(hjust=0.5),
    legend.position = "none"
    )+
  ylim(0,225000)
```


```{r CompletePortfolio_GRAPHS}
grid.arrange(barC18, barC19, barC20, barC21, ncol=2)
grid.arrange(barS18, barS19, barS20, barS21, ncol=2)
barC21_solo
barS21_solo
anualc
anuals

barNC_complete
barMC_complete
```

```{r MAPASCODE}
# PASO1: Instalar u UPDATEAR los pquetes cli y ellipsis, luego cargarlos:
library("ellipsis")
library("cli")

# PASO2:Instalar el paquete devtools:
library("devtools")
# Warning: si no te corre devtools updatea los paquetes que salgan en el mensaje de error!!

# PASO3: instala el paquete de los mapas directo de github:
install_github("diegovalle/mxmaps")
library("mxmaps")

# PASO4: Ahora, poner en la TERMILAL: brew install pkg-config
# PASO5: Luego poner en la TERMINAL: brew install gdal

# PASO6: corre el siguiente código. Si en la consola te pregnuta algo yes/no/cancel ponle:NO
library("devtools")
install.packages("sf", configure.args = "--with-proj-lib=/usr/local/lib/")
install_github("r-spatial/sf", configure.args = "--with-proj-lib=/usr/local/lib/")
install.packages("rgdal", configure.args = c("--with-proj-lib=/usr/local/lib/", "--with-proj-include=/usr/local/include/"))
```

```{r MAPAS}
# PASO7: Ahora sí los datos. Las columnas tienen que llamarse "value" y "region" para que lo lea y luego la función que se usa es mxstate_choropleth():

# ICV CUENTAS a abril 2021
ICV_C21<-subset(C_21,select=-c(Fecha,Vigente,Prorroga,Vencida,Total,Estado))
Clave_Estado<-c(01,02,03,04,05,06,07,08,09,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32)
ICV_C21$Clave=Clave_Estado
colnames(ICV_C21)<-c("value","region")
library("mxmaps")
mxstate_choropleth(ICV_C21,
                   num_colors=1,
                   title="Índice de cartera vencida por estado (número de cuentas) (A 2021/04)",
                   legend="ICV")

# ICV SALDOS a abril 2021
ICV_S21<-subset(S_21,select=-c(Fecha,Vigente,Prorroga,Vencida,Total,Estado))
ICV_S21$Clave=Clave_Estado
colnames(ICV_S21)<-c("value","region")
library("mxmaps")
mxstate_choropleth(ICV_S21,
                   num_colors=1,
                   title="Índice de cartera vencida por estado (saldos MXN) (A 2021/04)",
                   legend="ICV")

# Número de créditos 2013/01 - 2021/04
NC_1321<-subset(NC_Estado,select=-c(percent,Estado))
NC_1321$region=Clave_Estado
colnames(NC_1321)=c("value","region")
library("mxmaps")
mxstate_choropleth(NC_1321,
                   num_colors=1,
                   title="Número de créditos originados 2013/01 - 2021/04",
                   legend="# de cred.")

# Monto de créditos 2013/01 - 2021/04
MC_1321<-subset(MC_Estado,select=-c(percent,Estado,MC_NC))
MC_1321$region=Clave_Estado
colnames(MC_1321)=c("value","region")
library("mxmaps")
mxstate_choropleth(MC_1321,
                   num_colors=1,
                   title="Monto de créditos originados 2013/01 - 2021/04 ($MXN)",
                   legend="$MXN")

# Número de subsidios 2013/01 - 2021/04
NS_1321<-subset(NS_Estado,select=-c(percent,Estado,NS))
NS_1321$region=Clave_Estado
colnames(NS_1321)=c("value","region")
library("mxmaps")
mxstate_choropleth(NS_1321,
                   num_colors=1,
                   title="Número de subsidios como porcentaje del total de créditos 2013/01 - 2021/04",
                   legend="%")

# Monto de subsidios otorgados 2013/01 - 2021/04
MS_Estado$prop<-MS_Estado$MS/MC_Estado$MC
MS_1321<-subset(MS_Estado,select=-c(Estado,MS,percent))
MS_1321$region=Clave_Estado
colnames(MS_1321)=c("value","region")
library("mxmaps")
mxstate_choropleth(MS_1321,
                   num_colors=1,
                   title="Monto de subsidios como porcentaje del monto total 2013/01 - 2021/04",
                   legend="%")
```
# Sample data

Now, we consider our main database. This is the data from where we intend to develop our credit risk model; it describes credits originated from January 2013 to April 2021 *individually*, characterizing each beneficiary by different variables like age, gender, type of dwelling, etc. Source: https://sniiv.conavi.gob.mx/reportes/datos_abiertos.aspx

In theory, this data base should be exactly the same as the data analyzed at the beginning, reported in "Sistema de Información Infonavit" for 2013/01-2021/04 in Number and Amount of Credits (NC & MC). However, we do not expect this database to be distributed exactly the same as the **complete portfolio** information. We intend to manipulate this sample to best resemble the complete portfolio, so that the credit risk model can more accurately represent reality.

## Data Analysis
```{r LoadingData3, include = FALSE}
sample<-readRDS(file="DATA/MUESTRA.Rds")
head(sample)
tail(sample)
str(sample)
summary(sample)
prueba<-subset(sample,sample$MONTO!=0)
sample
prueba2<-subset(sample,sample$AÑO=="2020")
nrow(prueba2)
prueba2
sample99 <- sample %>% 
  group_by(CLAVE_ENTIDAD) %>%
  mutate(count_name_occurr = n())

bar_estado <- ggplot(sample99, aes(x=reorder(CLAVE_ENTIDAD,-count_name_occurr),fill=CLAVE_ENTIDAD))

bar_estado + 
  geom_bar(aes(y=(..count..))) + 
  ylab("Total de Créditos") + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "none") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Créditos con monto NO cero por Estado") + 
  theme(plot.title=element_text(hjust = 0.5))

barplot_NC_Estado
```

```{r Créditos por Modalidad}
colourCount <- length(unique(sample$MODALIDAD))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample2 <- sample %>% 
  group_by(MODALIDAD) %>%
  mutate(count_name_occurr = n())

bar_modalidad <- ggplot(sample2, aes(x=reorder(MODALIDAD,-count_name_occurr),fill=MODALIDAD))

bar_modalidad + 
  geom_bar(aes(y=(..count..)/sum(..count..))) +
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(colourCount)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "none") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Modalidad") + 
  theme(plot.title=element_text(hjust = 0.5))  
```

```{r Créditos por Destino}

colourCount <- length(unique(sample$DESTINO))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample4 <- sample %>% 
  group_by(DESTINO) %>%
  mutate(count_name_occurr = n())

bar_estado <- ggplot(sample4, aes(x=reorder(DESTINO,-count_name_occurr),fill=DESTINO))

bar_estado + 
  geom_bar(aes(y=(..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(colourCount)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "none") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Destino") + 
  theme(plot.title=element_text(hjust = 0.5))
```

```{r Créditos por Tipo}
colourCount <- length(unique(sample$TIPO))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample2 <- sample %>% 
  group_by(TIPO) %>%
  mutate(count_name_occurr = n())

bar_modalidad <- ggplot(sample2, aes(x=reorder(TIPO,-count_name_occurr),fill=TIPO))

bar_modalidad + 
  geom_bar(aes(y=(..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(colourCount)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "none") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Tipo") + 
  theme(plot.title=element_text(hjust = 0.5))
```

```{r Créditos por Monto}
hist_info <- hist(sample$MONTO,xlim=c(0,10000),breaks=4000)       
hist_info$density <- hist_info$counts/sum(hist_info$counts) * 100 
plot(hist_info, freq = FALSE,xlim=c(0,5000000),xaxt="n",ylim=c(0,30),ylab="% / Cantidad Total de Créditos",xlab="Monto",main="Distribución de los Montos de los Créditos")   
axis(side=1, at=axTicks(1), labels=formatC(axTicks(1), format="d", big.mark=','))
```

```{r Créditos por Entidad}
colourCount <- length(unique(sample$ENTIDAD))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample3 <- sample %>% 
  group_by(CLAVE_ENTIDAD) %>%
  mutate(count_name_occurr = n())

bar_estado <- ggplot(sample3, aes(x=reorder(CLAVE_ENTIDAD,-count_name_occurr),fill=CLAVE_ENTIDAD))

bar_estado + 
  geom_bar(aes(y=(..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(32)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "none") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Estado") + 
  theme(plot.title=element_text(hjust = 0.5))
```

```{r Créditos por Entidad y Tipo}
colourCount <- length(unique(sample$TIPO))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample3 <- sample %>% 
  group_by(ENTIDAD) %>%
  mutate(count_name_occurr = n())

bar_estado <- ggplot(sample3, aes(x=reorder(ENTIDAD,-count_name_occurr),fill=TIPO))

bar_estado + 
  geom_bar(aes(y=(..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(colourCount)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "right") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Estado y Tipo") + 
  theme(plot.title=element_text(hjust = 0.5))
```

```{r Créditos por Género}
colourCount <- length(unique(sample$GENERO))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample3 <- sample %>% 
  group_by(GENERO) %>%
  mutate(count_name_occurr = n())

bar_estado <- ggplot(sample3, aes(x=reorder(GENERO,-count_name_occurr),fill=GENERO))

bar_estado + 
  geom_bar(aes(y=(..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(colourCount)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "none") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Género") + 
  theme(plot.title=element_text(hjust = 0.5))
```

```{r Créditos por Entidad y Género}
colourCount <- length(unique(sample$GENERO))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample3 <- sample %>% 
  group_by(ENTIDAD) %>%
  mutate(count_name_occurr = n())

bar_estado <- ggplot(sample3, aes(x=reorder(ENTIDAD,-count_name_occurr),fill=GENERO))

bar_estado + 
  geom_bar(aes(y=(..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(colourCount)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "right") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Estado y Género") + 
  theme(plot.title=element_text(hjust = 0.5))
```

```{r Créditos por Estado y Edad}

colourCount <- length(unique(sample$EDAD))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample3 <- sample %>% 
  group_by(ENTIDAD) %>%
  mutate(count_name_occurr = n())

bar_estado <- ggplot(sample3, aes(x=reorder(ENTIDAD,-count_name_occurr),fill=EDAD))

bar_estado + 
  geom_bar(aes(y=(..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(colourCount)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "right") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Estado y Edad") + 
  theme(plot.title=element_text(hjust = 0.5))
```

```{r Créditos por Edad}
colourCount <- length(unique(sample$EDAD))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample3 <- sample %>% 
  group_by(EDAD) %>%
  mutate(count_name_occurr = n())

bar_estado <- ggplot(sample3, aes(x=reorder(EDAD,-count_name_occurr),fill=EDAD))

bar_estado + 
  geom_bar(aes(y=(..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(colourCount)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "none") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Edad") + 
  theme(plot.title=element_text(hjust = 0.5))
```

```{r Créditos por Edad y Género}
colourCount <- length(unique(sample$GENERO))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample3 <- sample %>% 
  group_by(EDAD) %>%
  mutate(count_name_occurr = n())

bar_estado <- ggplot(sample3, aes(x=reorder(EDAD,-count_name_occurr),fill=GENERO))

bar_estado + 
  geom_bar(aes(y=(..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(colourCount)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "right") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Edad y Género") + 
  theme(plot.title=element_text(hjust = 0.5))
```

```{r Créditos por Ingreso}
colourCount <- length(unique(sample$INGRESO))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample3 <- sample %>% 
  group_by(INGRESO) %>%
  mutate(count_name_occurr = n())

bar_estado <- ggplot(sample3, aes(x=reorder(INGRESO,-count_name_occurr),fill=INGRESO))

bar_estado + 
  geom_bar(aes(y=(..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(colourCount)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "none") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Ingreso") + 
  theme(plot.title=element_text(hjust = 0.5))
```

```{r Créditos por Ingreso y Edad}
colourCount <- length(unique(sample$EDAD))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample3 <- sample %>% 
  group_by(INGRESO) %>%
  mutate(count_name_occurr = n())

bar_estado <- ggplot(sample3, aes(x=reorder(INGRESO,-count_name_occurr),fill=EDAD))

bar_estado + 
  geom_bar(aes(y=(..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(colourCount)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "right") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Ingreso y Edad") + 
  theme(plot.title=element_text(hjust = 0.5))
```

```{r Créditos por Ingreso y Género}
colourCount <- length(unique(sample$GENERO))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample3 <- sample %>% 
  group_by(INGRESO) %>%
  mutate(count_name_occurr = n())

bar_estado <- ggplot(sample3, aes(x=reorder(INGRESO,-count_name_occurr),fill=GENERO))

bar_estado + 
  geom_bar(aes(y=(..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(colourCount)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "right") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Ingreso y Género") + 
  theme(plot.title=element_text(hjust = 0.5))
```

```{r Créditos por Ingreso y Tipo}
colourCount <- length(unique(sample$TIPO))
getPalette <- colorRampPalette(brewer.pal(9, "Set1"))

sample3 <- sample %>% 
  group_by(INGRESO) %>%
  mutate(count_name_occurr = n())

bar_estado <- ggplot(sample3, aes(x=reorder(INGRESO,-count_name_occurr),fill=TIPO))

bar_estado + 
  geom_bar(aes(y=(..count..)/sum(..count..))) + 
  scale_y_continuous(labels=scales::percent) + 
  ylab("% / Total de Créditos") + 
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Accent"))(colourCount)) + 
  theme(axis.text.x = element_text(angle=90, vjust=0.5,hjust=1)) + 
  theme(legend.position = "right") +
  theme(axis.title.x = element_blank()) + 
  ggtitle("Distribución de Créditos otorgados por Ingreso y Tipo") + 
  theme(plot.title=element_text(hjust = 0.5))
```

## Adjust Sample to Match Population's Characteristics 
```{r}
# Berny
```

## Asign Variable Status
```{r}
# Luly
```

## Subsidies
```{r}
```

# Credit Risk Model

## Logistic Regression
```{r}
```

## Evaluation
```{r}
```

## Regional Analysis & Clusters
```{r}
```

# Building a Cross-Subsidy Scheme

## Asigning an Interest Rate
```{r}
```

# Comparative Statics & Tests
```{r}
```
